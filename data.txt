-- ============================================
-- ê¸‰ì—¬ ë° ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ ì™„ì „ ì„¤ì •
-- í…Œì´ë¸” ìƒì„±ë¶€í„° ìƒ˜í”Œ ë°ì´í„°ê¹Œì§€ í•œë²ˆì— ì²˜ë¦¬
-- Supabase SQL Editorì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”
-- ============================================

-- 1. ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ (ì™„ì „ ì´ˆê¸°í™”)
DROP TABLE IF EXISTS payroll CASCADE;
DROP TABLE IF EXISTS attendance CASCADE;
DROP TABLE IF EXISTS employees CASCADE;

-- 2. ì§ì› í…Œì´ë¸” ìƒì„±
CREATE TABLE employees (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    position VARCHAR(100),
    department VARCHAR(100),
    hire_date DATE,
    total_annual_leave INTEGER DEFAULT 15,
    used_annual_leave INTEGER DEFAULT 0,
    remaining_annual_leave INTEGER DEFAULT 15,
    notes TEXT,
    status VARCHAR(20) DEFAULT 'ì¬ì§',
    email VARCHAR(255),
    phone VARCHAR(20),
    base_salary BIGINT DEFAULT 0,
    family_count INTEGER DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. ê·¼íƒœ í…Œì´ë¸” ìƒì„±
CREATE TABLE attendance (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT REFERENCES employees(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    clock_in TIME,
    clock_out TIME,
    actual_hours DECIMAL(4,2),
    status VARCHAR(20) DEFAULT 'ì •ìƒ',
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. ê¸‰ì—¬ í…Œì´ë¸” ìƒì„±
CREATE TABLE payroll (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT REFERENCES employees(id) ON DELETE CASCADE,
    pay_month VARCHAR(7) NOT NULL,
    base_salary BIGINT DEFAULT 0,
    performance_bonus BIGINT DEFAULT 0,
    attendance_allowance BIGINT DEFAULT 0,
    meal_allowance BIGINT DEFAULT 0,
    holiday_allowance BIGINT DEFAULT 0,
    position_allowance BIGINT DEFAULT 0,
    special_duty_allowance BIGINT DEFAULT 0,
    overtime_allowance BIGINT DEFAULT 0,
    skill_allowance BIGINT DEFAULT 0,
    annual_leave_allowance BIGINT DEFAULT 0,
    other_allowance BIGINT DEFAULT 0,
    national_pension BIGINT DEFAULT 0,
    health_insurance BIGINT DEFAULT 0,
    long_term_care BIGINT DEFAULT 0,
    employment_insurance BIGINT DEFAULT 0,
    income_tax BIGINT DEFAULT 0,
    resident_tax BIGINT DEFAULT 0,
    total_deductions BIGINT DEFAULT 0,
    net_pay BIGINT DEFAULT 0,
    is_paid BOOLEAN DEFAULT FALSE,
    pay_date DATE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 5. ì¸ë±ìŠ¤ ìƒì„± (ì„±ëŠ¥ í–¥ìƒ)
CREATE INDEX idx_employees_status ON employees(status);
CREATE INDEX idx_employees_department ON employees(department);
CREATE INDEX idx_attendance_employee_date ON attendance(employee_id, date);
CREATE INDEX idx_attendance_date ON attendance(date);
CREATE INDEX idx_payroll_employee_month ON payroll(employee_id, pay_month);
CREATE INDEX idx_payroll_pay_month ON payroll(pay_month);

-- 6. ì œì•½ ì¡°ê±´ ì¶”ê°€
ALTER TABLE employees ADD CONSTRAINT chk_status CHECK (status IN ('ì¬ì§', 'íœ´ì§', 'í‡´ì§'));
ALTER TABLE attendance ADD CONSTRAINT chk_attendance_status CHECK (status IN ('ì •ìƒ', 'ì§€ê°', 'ì¡°í‡´', 'ì—°ì°¨', 'ê²°ê·¼', 'íœ´ê°€'));
ALTER TABLE attendance ADD CONSTRAINT chk_actual_hours CHECK (actual_hours >= 0 AND actual_hours <= 24);
ALTER TABLE employees ADD CONSTRAINT chk_family_count CHECK (family_count >= 1 AND family_count <= 20);
ALTER TABLE employees ADD CONSTRAINT chk_base_salary CHECK (base_salary >= 0);

-- 7. ìƒ˜í”Œ ì§ì› ë°ì´í„° ì‚½ì…
INSERT INTO employees (
    name, position, department, hire_date, base_salary, family_count,
    email, phone, status, total_annual_leave, used_annual_leave, 
    remaining_annual_leave, notes
) VALUES 
(
    'í™ê¸¸ë™', 'íŒ€ì¥', 'ê°œë°œíŒ€', '2021-03-15', 4500000, 3,
    'hong@company.com', '010-1111-2222', 'ì¬ì§', 18, 5, 13,
    'í’€ìŠ¤íƒ ê°œë°œì, React/Node.js ì „ë¬¸'
),
(
    'ê¹€ì‚¬ë˜', 'ê³¼ì¥', 'ì˜ì—…íŒ€', '2020-07-01', 4200000, 4,
    'kim.satto@company.com', '010-2222-3333', 'ì¬ì§', 20, 8, 12,
    'ëŒ€ê¸°ì—… ì˜ì—… ì „ë¬¸ê°€, B2B ì„¸ì¼ì¦ˆ 10ë…„ ê²½ë ¥'
),
(
    'ê¹€ë²¼ìŠ¬', 'ëŒ€ë¦¬', 'ì¸ì‚¬íŒ€', '2022-01-10', 3200000, 2,
    'kim.byeol@company.com', '010-3333-4444', 'ì¬ì§', 16, 3, 13,
    'ì¸ì‚¬ ê´€ë¦¬ ë‹´ë‹¹, ë…¸ë¬´ì‚¬ ìê²©ì¦ ë³´ìœ '
),
(
    'ì†¡ë§ˆì„', 'ì‚¬ì›', 'ë§ˆì¼€íŒ…íŒ€', '2023-09-05', 2800000, 1,
    'song@company.com', '010-4444-5555', 'ì¬ì§', 15, 2, 13,
    'ë””ì§€í„¸ ë§ˆì¼€íŒ… ì „ë¬¸, SNS/ë°”ì´ëŸ´ ë§ˆì¼€íŒ…'
);

-- 8. ìƒ˜í”Œ ê·¼íƒœ ë°ì´í„° ì‚½ì…
INSERT INTO attendance (employee_id, date, clock_in, clock_out, actual_hours, status, notes) VALUES
-- í™ê¸¸ë™ ê·¼íƒœ (id=1)
(1, '2025-01-02', '08:45', '18:30', 8.75, 'ì •ìƒ', ''),
(1, '2025-01-03', '09:00', '18:00', 8.0, 'ì •ìƒ', ''),
(1, '2025-01-06', '09:15', '18:15', 8.0, 'ì§€ê°', 'êµí†µì²´ì¦'),
(1, '2025-01-07', '08:50', '18:20', 8.5, 'ì •ìƒ', ''),
(1, '2025-01-08', '09:00', '17:30', 7.5, 'ì¡°í‡´', 'ë³‘ì› ë°©ë¬¸'),
(1, '2025-01-09', '08:45', '19:00', 9.25, 'ì •ìƒ', 'í”„ë¡œì íŠ¸ ì•¼ê·¼'),
(1, '2025-01-10', '00:00', '00:00', 0.0, 'ì—°ì°¨', 'ê°œì¸ ì‚¬ìœ '),
(1, '2025-01-13', '08:55', '18:05', 8.17, 'ì •ìƒ', ''),
(1, '2025-01-14', '09:00', '18:30', 8.5, 'ì •ìƒ', ''),
(1, '2025-01-15', '08:40', '18:10', 8.5, 'ì •ìƒ', ''),

-- ê¹€ì‚¬ë˜ ê·¼íƒœ (id=2)
(2, '2025-01-02', '08:30', '17:45', 8.25, 'ì •ìƒ', ''),
(2, '2025-01-03', '08:45', '18:15', 8.5, 'ì •ìƒ', ''),
(2, '2025-01-06', '09:00', '18:00', 8.0, 'ì •ìƒ', ''),
(2, '2025-01-07', '08:50', '19:30', 9.67, 'ì •ìƒ', 'ê³ ê°ì‚¬ ë¯¸íŒ…'),
(2, '2025-01-08', '08:45', '18:00', 8.25, 'ì •ìƒ', ''),
(2, '2025-01-09', '09:00', '17:00', 7.0, 'ì¡°í‡´', 'ê°€ì¡± í–‰ì‚¬'),
(2, '2025-01-10', '08:30', '18:30', 9.0, 'ì •ìƒ', ''),
(2, '2025-01-13', '09:10', '18:10', 8.0, 'ì§€ê°', ''),
(2, '2025-01-14', '08:45', '18:15', 8.5, 'ì •ìƒ', ''),
(2, '2025-01-15', '08:40', '17:50', 8.17, 'ì •ìƒ', ''),

-- ê¹€ë²¼ìŠ¬ ê·¼íƒœ (id=3)
(3, '2025-01-02', '09:00', '18:00', 8.0, 'ì •ìƒ', ''),
(3, '2025-01-03', '09:05', '18:05', 8.0, 'ì§€ê°', ''),
(3, '2025-01-06', '08:55', '18:00', 8.08, 'ì •ìƒ', ''),
(3, '2025-01-07', '09:00', '18:15', 8.25, 'ì •ìƒ', ''),
(3, '2025-01-08', '09:00', '18:00', 8.0, 'ì •ìƒ', ''),
(3, '2025-01-09', '08:50', '17:30', 7.67, 'ì¡°í‡´', 'ë°˜ì°¨ ì‚¬ìš©'),
(3, '2025-01-10', '00:00', '00:00', 0.0, 'ì—°ì°¨', 'ë³‘ê°€'),
(3, '2025-01-13', '08:45', '18:30', 8.75, 'ì •ìƒ', ''),
(3, '2025-01-14', '09:00', '18:00', 8.0, 'ì •ìƒ', ''),
(3, '2025-01-15', '08:55', '18:10', 8.25, 'ì •ìƒ', ''),

-- ì†¡ë§ˆì„ ê·¼íƒœ (id=4)
(4, '2025-01-02', '09:15', '18:15', 8.0, 'ì§€ê°', 'ì§€í•˜ì²  ì—°ì°©'),
(4, '2025-01-03', '09:00', '18:30', 8.5, 'ì •ìƒ', ''),
(4, '2025-01-06', '08:45', '18:00', 8.25, 'ì •ìƒ', ''),
(4, '2025-01-07', '09:00', '18:45', 8.75, 'ì •ìƒ', 'ìº í˜ì¸ ì¤€ë¹„'),
(4, '2025-01-08', '09:05', '18:05', 8.0, 'ì§€ê°', ''),
(4, '2025-01-09', '09:00', '19:00', 9.0, 'ì •ìƒ', 'ì´ë²¤íŠ¸ ì§„í–‰'),
(4, '2025-01-10', '08:50', '18:20', 8.5, 'ì •ìƒ', ''),
(4, '2025-01-13', '09:00', '18:00', 8.0, 'ì •ìƒ', ''),
(4, '2025-01-14', '08:45', '17:45', 8.0, 'ì •ìƒ', ''),
(4, '2025-01-15', '09:10', '18:10', 8.0, 'ì§€ê°', '');

-- 9. 2024ë…„ 12ì›” ê¸‰ì—¬ ë°ì´í„° (ì§€ê¸‰ ì™„ë£Œ)
INSERT INTO payroll (
    employee_id, pay_month, base_salary, performance_bonus, meal_allowance, 
    position_allowance, overtime_allowance, national_pension, health_insurance, 
    long_term_care, employment_insurance, income_tax, resident_tax, 
    total_deductions, net_pay, is_paid, pay_date
) VALUES 
-- í™ê¸¸ë™ 2024ë…„ 12ì›”
(1, '2024-12', 4500000, 300000, 130000, 200000, 150000, 
 202500, 159525, 20658, 40500, 156000, 15600, 594283, 4735717, true, '2024-12-25'),

-- ê¹€ì‚¬ë˜ 2024ë…„ 12ì›”
(2, '2024-12', 4200000, 250000, 130000, 150000, 80000,
 189000, 148890, 19276, 37800, 128000, 12800, 535766, 4274234, true, '2024-12-25'),

-- ê¹€ë²¼ìŠ¬ 2024ë…„ 12ì›”
(3, '2024-12', 3200000, 150000, 130000, 100000, 50000,
 144000, 113440, 14684, 28800, 78000, 7800, 386724, 3243276, true, '2024-12-25'),

-- ì†¡ë§ˆì„ 2024ë…„ 12ì›”
(4, '2024-12', 2800000, 100000, 130000, 50000, 70000,
 126000, 99260, 12849, 25200, 58000, 5800, 327109, 2822891, true, '2024-12-25');

-- 10. 2025ë…„ 1ì›” ê¸‰ì—¬ ë°ì´í„° (ì§€ê¸‰ ëŒ€ê¸°, pay_dateëŠ” NULL)
INSERT INTO payroll (
    employee_id, pay_month, base_salary, performance_bonus, meal_allowance, 
    position_allowance, overtime_allowance, national_pension, health_insurance, 
    long_term_care, employment_insurance, income_tax, resident_tax, 
    total_deductions, net_pay, is_paid
) VALUES 
-- í™ê¸¸ë™ 2025ë…„ 1ì›”
(1, '2025-01', 4500000, 0, 130000, 200000, 120000, 
 202500, 159525, 20658, 40500, 156000, 15600, 594283, 4455717, false),

-- ê¹€ì‚¬ë˜ 2025ë…„ 1ì›”
(2, '2025-01', 4200000, 0, 130000, 150000, 100000,
 189000, 148890, 19276, 37800, 128000, 12800, 535766, 4044234, false),

-- ê¹€ë²¼ìŠ¬ 2025ë…„ 1ì›”
(3, '2025-01', 3200000, 0, 130000, 100000, 40000,
 144000, 113440, 14684, 28800, 78000, 7800, 386724, 3083276, false),

-- ì†¡ë§ˆì„ 2025ë…„ 1ì›”
(4, '2025-01', 2800000, 0, 130000, 50000, 90000,
 126000, 99260, 12849, 25200, 58000, 5800, 327109, 2772891, false);

-- 11. ë°ì´í„° í™•ì¸ ì¿¼ë¦¬
SELECT 'âœ… ì§ì› ë°ì´í„°' AS í•­ëª©, COUNT(*) AS ê±´ìˆ˜ FROM employees
UNION ALL
SELECT 'âœ… ê·¼íƒœ ë°ì´í„°' AS í•­ëª©, COUNT(*) AS ê±´ìˆ˜ FROM attendance
UNION ALL  
SELECT 'âœ… ê¸‰ì—¬ ë°ì´í„°' AS í•­ëª©, COUNT(*) AS ê±´ìˆ˜ FROM payroll;

-- 12. ìƒ˜í”Œ ì¡°íšŒ ì¿¼ë¦¬

-- ì§ì› ì •ë³´
SELECT 
    'ğŸ‘¥ ì§ì› ì •ë³´' AS êµ¬ë¶„,
    name AS ì´ë¦„,
    position AS ì§ê¸‰,
    department AS ë¶€ì„œ,
    base_salary AS ê¸°ë³¸ê¸‰,
    family_count AS ë¶€ì–‘ê°€ì¡±ìˆ˜,
    status AS ìƒíƒœ
FROM employees 
ORDER BY base_salary DESC;

-- ìµœê·¼ ê·¼íƒœ í˜„í™©
SELECT 
    'â° ìµœê·¼ ê·¼íƒœ' AS êµ¬ë¶„,
    e.name AS ì´ë¦„,
    a.date AS ë‚ ì§œ,
    a.clock_in AS ì¶œê·¼,
    a.clock_out AS í‡´ê·¼,
    a.actual_hours AS ê·¼ë¬´ì‹œê°„,
    a.status AS ìƒíƒœ
FROM attendance a
JOIN employees e ON a.employee_id = e.id
ORDER BY a.date DESC, e.name
LIMIT 10;

-- ê¸‰ì—¬ í˜„í™© (2025ë…„ 1ì›”)
SELECT 
    'ğŸ’° 2025ë…„ 1ì›” ê¸‰ì—¬' AS êµ¬ë¶„,
    e.name AS ì´ë¦„,
    p.base_salary AS ê¸°ë³¸ê¸‰,
    p.total_deductions AS ì´ê³µì œ,
    p.net_pay AS ì‹¤ì§€ê¸‰ì•¡,
    CASE WHEN p.is_paid THEN 'ì§€ê¸‰ì™„ë£Œ' ELSE 'ì§€ê¸‰ëŒ€ê¸°' END AS ìƒíƒœ
FROM payroll p
JOIN employees e ON p.employee_id = e.id  
WHERE p.pay_month = '2025-01'
ORDER BY p.net_pay DESC;

-- ì™„ë£Œ ë©”ì‹œì§€
SELECT 'ğŸ‰ ê¸‰ì—¬ ê´€ë¦¬ ì‹œìŠ¤í…œ ì…‹ì—… ì™„ë£Œ!' AS ì™„ë£Œ;